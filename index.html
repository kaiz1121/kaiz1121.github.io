<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="知其白，守其黑，为天下式。">
<meta property="og:type" content="website">
<meta property="og:title" content="Kaiz">
<meta property="og:url" content="http://kaiz.top/index.html">
<meta property="og:site_name" content="Kaiz">
<meta property="og:description" content="知其白，守其黑，为天下式。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kaiz">
<meta name="twitter:description" content="知其白，守其黑，为天下式。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kaiz.top/">





  <title>Kaiz</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kaiz</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kaiz.top/2019/10/08/SpringBoot2启动原理与流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kaiz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kaiz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/08/SpringBoot2启动原理与流程/" itemprop="url">SpringBoot2启动原理与流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-08T18:29:49+08:00">
                2019-10-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringBoot/" itemprop="url" rel="index">
                    <span itemprop="name">SpringBoot</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li style="list-style: none"><input type="checkbox"> 核心注解@SpringBootApplication</li>
<li style="list-style: none"><input type="checkbox"> main方法入口(执行流程run)</li>
</ul>
<h2 id="一-核心注解-SpringBootApplication"><a href="#一-核心注解-SpringBootApplication" class="headerlink" title="一.核心注解@SpringBootApplication"></a>一.核心注解@SpringBootApplication</h2><p>由图可见，该注解为组合注解， 由以下注解组合而成，如下图所示：</p>
<p><img src="https://ae01.alicdn.com/kf/Hf6b306a876964dde92792aa3bb7528c2q.png" alt="image-1"></p>
<h3 id="SpringBootConfiguration"><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration"></a>@SpringBootConfiguration</h3><p>该注解和我们在Spring中经常见到的@Configuration是一样的作用。只要标注了@Configuration的java类都被视作为一个JavaConfig配置类，在我们日常编码中常与@Bean搭配作为配置类，用于替换相应的xml配置文件。</p>
<p>比如在配置redis缓存管理器配置时，可通过该两个注解声明相关配置，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Title: RedisCacheConfig&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Description: redis缓存配置 &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kaiz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 14:51 2019-08-09.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置缓存管理器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">cacheManager</span><span class="params">(RedisConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                <span class="comment">// 设置key的序列化方式</span></span><br><span class="line">             .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(keySerializer()))</span><br><span class="line">                <span class="comment">// 设置value的序列化方式</span></span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(valueSerializer()));</span><br><span class="line"></span><br><span class="line">        RedisCacheManager redisCacheManager = RedisCacheManager.builder(connectionFactory)</span><br><span class="line">                .cacheDefaults(config)</span><br><span class="line">                .transactionAware()</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> redisCacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// key键序列化方式</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RedisSerializer&lt;String&gt; <span class="title">keySerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// value值序列化方式</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GenericJackson2JsonRedisSerializer <span class="title">valueSerializer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ComponentScan注解"><a href="#ComponentScan注解" class="headerlink" title="@ComponentScan注解"></a>@ComponentScan注解</h3><p>作用：自动扫描并加载符合条件的组件（比如@Component和@Repository等）或者bean定义，最终将这些bean定义加载到IoC容器中。<br>我们可以通过basePackages等属性来细粒度的定制@ComponentScan自动扫描的范围，如果不指定，则默认Spring框架实现会从声明@ComponentScan所在类的package进行扫描。<br>所以SpringBoot的启动类最好是放在root package下，因为默认不指定basePackages。</p>
<p>若要指定扫描的路径，在@SpringBootApplication注解后加上以下代码即：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages=&#123;<span class="string">"com.kaiz.demo"</span>&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="EnableAutoConfiguration"><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a>@EnableAutoConfiguration</h3><p>该注解是三个组合注解中的核心，以Enable开头的注解也应该不陌生，比如@EnableScheduling和上文中出现的@EnableCaching等。若是看过其核心类和实现你会发现其都是通过@Import收集和注册特定场景相关的bean定义然后加载到Spring IoC容器。</p>
<p>而我们这里的@EnableAutoConfiguration也是通过@Import将所有符合条件的Bean根据类路径中的jar依赖为项目进行自动配置加载到容器中。</p>
<p>该注解也是一个复合注解，如下所示：</p>
<p><img src="https://ae01.alicdn.com/kf/H0315cfb1e0414b38a66ff1e0f61e4d71O.png" alt="image-2"></p>
<p>那么问题来了，如何根据类路径自动加载bean到容器中的呢？关键在于AutoConfigurationImportSelector。</p>
<p>首先查看该类发现其选择加载类的逻辑中最重要的是从哪里获取的一块逻辑，如下：</p>
<p><img src="https://ae01.alicdn.com/kf/Hf16bc35599144c4b9587236412a6ad83i.png" alt="image-3"></p>
<p>getCandidateConfigurations方法如下：</p>
<p><img src="https://ae01.alicdn.com/kf/H699fd15f364849bf8c93e94b477149397.png" alt="image-4"></p>
<p>此时就会发现在该方法中核心是<strong>SpringFactoriesLoader</strong>，在该类中中有两个核心方法如下：</p>
<p><img src="https://ae01.alicdn.com/kf/Hb8efc5ab2f3f416fa9afaafed1fb6c4b5.png" alt="image-5"></p>
<p>可以看到一个重要的静态常量<strong>FACTORIES_RESOURCE_LOCATION</strong>，该值告诉了spring要去哪里去找路径去加载bean到容器中，该常量的值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">"META-INF/spring.factories"</span>;</span><br></pre></td></tr></table></figure>
<p>我这边找的是autoconfigure包下的spring.factories，内容如下：</p>
<p><img src="https://ae01.alicdn.com/kf/H55c3bfbd3ada40d8acd91497c35a963bv.png" alt="image-6"></p>
<p>总的来说<strong>SpringFactoriesLoader</strong>的作用就是为了从指定的配置文件META-INF/spring.factories加载配置。</p>
<p>当配合@EnableAutoConfiguration注解时，就会以key为org.springframework.boot.autoconfigure.EnableAutoConfiguration获取一系列配置类。</p>
<p>所以<strong>@EnableAutoConfiguration的原理</strong>总结如下：</p>
<p>从classpath中搜寻所有的META-INF/spring.factories配置文件，并将其中org.springframework.boot.autoconfigure.EnableutoConfiguration对应的配置项列表通过反射实例化为对应的标注了@Configuration的JavaConfig形式的IoC容器配置类，然后汇总并加载到IoC容器。</p>
<h2 id="二-main方法入口-执行流程run"><a href="#二-main方法入口-执行流程run" class="headerlink" title="二.main方法入口(执行流程run)"></a>二.main方法入口(执行流程run)</h2><p>该方法的主要流程大体可以归纳如下：（核心代码模块可自行对照流程阅读源码）<br>1.如果我们使用的是SpringApplication的静态run方法，那么，这个方法里面首先要创建一个SpringApplication对象实例，然后调用这个创建好的SpringApplication的实例方法。在SpringApplication实例初始化的时候，它会提前做几件事情：<br>A.根据classpath里面是否存在某个特征类（org.springframework.web.context.ConfigurableWebApplicationContext）来决定是否应该创建一个为Web应用使用的ApplicationContext类型。<br>B.使用SpringFactoriesLoader在应用的classpath中查找并加载所有可用的ApplicationContextInitializer。<br>C.使用SpringFactoriesLoader在应用的classpath中查找并加载所有可用的ApplicationListener。<br>D.推断并设置main方法的定义类。<br>2.SpringApplication实例初始化完成并且完成设置后，就开始执行run方法的逻辑了，方法执行伊始，首先遍历执行所有通过SpringFactoriesLoader可以查找到并加载的SpringApplicationRunListener。调用它们的started()方法，告诉这些SpringApplicationRunListener，“嘿，SpringBoot应用要开始执行咯！”。<br>3.创建并配置当前Spring Boot应用将要使用的Environment（包括配置要使用的PropertySource以及Profile）。<br>4.遍历调用所有SpringApplicationRunListener的environmentPrepared()的方法，告诉他们：“当前SpringBoot应用使用的Environment准备好了咯！”。</p>
<ol start="5">
<li>如果SpringApplication的showBanner属性被设置为true，则打印banner。<br>6.根据用户是否明确设置了applicationContextClass类型以及初始化阶段的推断结果，决定该为当前SpringBoot应用创建什么类型的ApplicationContext并创建完成，然后根据条件决定是否添加ShutdownHook，决定是否使用自定义的BeanNameGenerator，决定是否使用自定义的ResourceLoader，当然，最重要的，将之前准备好的Environment设置给创建好的ApplicationContext使用。</li>
<li>ApplicationContext创建好之后，SpringApplication会再次借助Spring-FactoriesLoader，查找并加载classpath中所有可用的ApplicationContext-Initializer，然后遍历调用这些ApplicationContextInitializer的initialize（applicationContext）方法来对已经创建好的ApplicationContext进行进一步的处理。<br>8.遍历调用所有SpringApplicationRunListener的contextPrepared()方法。<br>9.最核心的一步，将之前通过@EnableAutoConfiguration获取的所有配置以及其他形式的IoC容器配置加载到已经准备完毕的ApplicationContext。<br>10.遍历调用所有SpringApplicationRunListener的contextLoaded()方法。<br>11.调用ApplicationContext的refresh()方法，完成IoC容器可用的最后一道工序。<br>12.查找当前ApplicationContext中是否注册有CommandLineRunner，如果有，则遍历执行它们。<br>13.正常情况下，遍历执行SpringApplicationRunListener的finished()方法、（如果整个过程出现异常，则依然调用所有SpringApplicationRunListener的finished()方法，只不过这种情况下会将异常信息一并传入处理）</li>
</ol>
<p><strong>以上流程基于SpringBoot1.x版本，2版本流程有所区别，不过总结下来都是：</strong></p>
<p><strong>第一部分进行SpringApplication的初始化模块，配置一些基本的环境变量、资源、构造器、监听器。</strong></p>
<p><strong>第二部分实现了应用具体的启动方案，包括启动流程的监听模块、加载配置环境模块、及核心的创建上下文环境模块。</strong></p>
<p><strong>第三部分是自动化配置模块。</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kaiz.top/2019/06/12/排序-冒泡排序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kaiz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kaiz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/12/排序-冒泡排序/" itemprop="url">排序-冒泡排序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-12T20:52:29+08:00">
                2019-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构与算法/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构与算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>花一段时间重新把基础排序和查找算法复习一遍。从排序开始，今天第一篇：冒泡排序。</p>
<ul>
<li><p>基本思想和时间复杂度</p>
</li>
<li><p>基础实现</p>
</li>
<li><p>优化版本1：通过有序标记减少循环次数</p>
</li>
<li><p>优化版本2：通过有序标记+无序数列边界减少循环次数</p>
</li>
<li><p>鸡尾酒排序：冒泡排序升级版</p>
</li>
</ul>
<ul>
<li><p>[ ] 基本思想和时间复杂度</p>
<ol>
<li>基本思想：将相邻的元素两两比较，当一个元素大于右侧相邻元素时，交换他们的位置；当一个元素小于或等于右侧相邻元素时，位置不变。</li>
<li>时间复杂度：冒泡排序每一轮都要遍历所有元素，两层循环，总共遍历(元素数量-1)轮，所以平均时间复杂度为O(n2) (n的平方哈。typora没搞定平方符号。。。) 。</li>
<li>稳定排序：两个值相等的元素不会打乱原本的顺序。</li>
</ol>
</li>
</ul>
<ul>
<li><p>[ ] 基本实现</p>
<p>无序数列{5，8，6，3，9，2，1，7}</p>
<p>|  5   |   8   |   6   |   3   |   9   |   2   |   1   |   7   | 原始顺序                    |<br>| :–: | :—: | :—: | :—: | :—: | :—: | :—: | :—: | ————————— |<br>|  5   |   6   |   3   |   8   |   2   |   1   |   7   | <strong>9</strong> | 第一轮 有序区为 9           |<br>|  5   |   3   |   6   |   2   |   1   |   7   | <strong>8</strong> | <strong>9</strong> | 第二轮 有序区为8 9          |<br>|  3   |   5   |   2   |   1   |   6   | <strong>7</strong> | <strong>8</strong> | <strong>9</strong> | 第三轮有序区为7 8 9         |<br>|  3   |   2   |   1   |   5   | <strong>6</strong> | <strong>7</strong> | <strong>8</strong> | <strong>9</strong> | 第四轮有序区为6 7 8 9       |<br>|  2   |   1   |   3   | <strong>5</strong> | <strong>6</strong> | <strong>7</strong> | <strong>8</strong> | <strong>9</strong> | 第五轮有序区为5 6 7 8 9     |<br>|  1   |   2   | <strong>3</strong> | <strong>5</strong> | <strong>6</strong> | <strong>7</strong> | <strong>8</strong> | <strong>9</strong> | 第六轮有序区为3 5 6 7 8 9   |<br>|  1   | <strong>2</strong> | <strong>3</strong> | <strong>5</strong> | <strong>6</strong> | <strong>7</strong> | <strong>8</strong> | <strong>9</strong> | 第七轮有序区为2 3 5 6 7 8 9 |</p>
<p>代码实现如下：双层循环，外部循环控制循环次数，内部循环进行每一次冒泡处理，先进行元素比较，再进行元素交换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span> arrary[])</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;arrary.length - <span class="number">1</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j&lt;arrary.length -i -<span class="number">1</span>;j++)&#123;</span><br><span class="line">                <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (arrary[j] &gt; arrary[j+<span class="number">1</span>])&#123;</span><br><span class="line">                    tmp = arrary[j];</span><br><span class="line">                    arrary[j] = arrary[j+<span class="number">1</span>];</span><br><span class="line">                    arrary[j+<span class="number">1</span>] = tmp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">5</span>,<span class="number">8</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">9</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">7</span>&#125;;</span><br><span class="line">        sort(array);</span><br><span class="line">        System.out.println(Arrays.toString(array));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>[ ] 优化版本1：通过有序标记减少循环次数</p>
<p>回头看上面基本实现中，当排序进行到第六轮时其实当前数列已经是有序的了，但是排序算法依旧执行了第七次，对1和2进行了排序。</p>
<p>所以，优化点在于如何在每次排序后判断当前数列是否有序，有序的话我就直接跳出最外层循环结束排序。如何做？即在每次内层循环(实际进行冒泡排序的循环)开始前，初始化一个有序标记 isSorted来作为有序无序的标志。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span> arrary[])</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;arrary.length - <span class="number">1</span>;i++)&#123;</span><br><span class="line">            <span class="comment">//有序标记，每一轮初始值为true ,默认有序</span></span><br><span class="line">            <span class="keyword">boolean</span> isSorted = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j&lt;arrary.length -i -<span class="number">1</span>;j++)&#123;</span><br><span class="line">                <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (arrary[j] &gt; arrary[j+<span class="number">1</span>])&#123;</span><br><span class="line">                    tmp = arrary[j];</span><br><span class="line">                    arrary[j] = arrary[j+<span class="number">1</span>];</span><br><span class="line">                    arrary[j+<span class="number">1</span>] = tmp;</span><br><span class="line">                    <span class="comment">//执行上面的逻辑代表还有元素进行交换了，所以不是有序的，有序标记设置为false</span></span><br><span class="line">                    isSorted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//在外层循环内判断有序标记，有序true直接结束循环，无序false则继续下一轮</span></span><br><span class="line">            <span class="keyword">if</span> (isSorted)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">5</span>,<span class="number">8</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">9</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">7</span>&#125;;</span><br><span class="line">        sort(array);</span><br><span class="line">        System.out.println(Arrays.toString(array));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，当执行完第六轮排序时，有序标记为true，因为 1 2 3 5 6 7 8 9 已然有序，不会进入内层循环的元素交换逻辑，直接跳出外层大循环，省去第七次排序。</p>
</li>
<li><p>[ ] 优化版本2：通过有序标记+无序数列边界减少循环次数</p>
<p>我们换一个数列说明情况, 新的排序数列{3，4，2，1，5，6，7，8}</p>
<p>这次不用表格示意了，我们直接话述。</p>
<p>第一轮排序：</p>
<p>元素3和4比较，位置不变</p>
<p>元素4和2比较，交换位置</p>
<p>元素4和1比较，交换位置</p>
<p>元素4和5比较，位置不变</p>
<p>元素5和6比较，位置不变</p>
<p>元素6和7比较，位置不变</p>
<p>元素7和8比较，位置不变</p>
<p><strong>第一轮排序结果为：{3，2，1，4，5，6，7，8}，有序区为8</strong></p>
</li>
</ul>
<p>  第二次排序：</p>
<p>  元素3和2比较，交换位置</p>
<p>  元素3和1比较，交换位置</p>
<p>  元素3和4比较，位置不变</p>
<p>  元素4和5比较，位置不变</p>
<p>  元素5和6比较，位置不变</p>
<p>  元素6和7比较，位置不变</p>
<p>  元素7和8比较，位置不变</p>
<p>  <strong>第二轮排序结果为：{2，1，3，4，5，6，7，8}，有序区为 7 8</strong> </p>
<p>  第三次排序：1，2，3，4，5，6，7，8</p>
<p>  。。。。。省略</p>
<p>  问题发现没，数列中5 6 7 8其实一直是有序的，但是每轮排序都比较了。</p>
<p>  问题关键点在于要<strong>对数列有序区进行界定</strong>。</p>
<p>  按照现有的排序逻辑，有序区的长度和排序的轮数是相等的。我每进行一次排序，有序区肯定会增加一个有序数列。第1轮排序后的有序区长度是1，第2轮排序后的有序长度是2.。。。。。</p>
<p>  但是，数列实际的有序区可能会大于这个长度，比如上面的数列，在第2轮排序时，后面的5个元素已经都是有序的了。我们可以在每一轮排序后，记录下来最后一次元素交换的位置，该位置即为无序数列的边界，从这个边界往后全部认为是有序的，不需要进行循环比对排序了。</p>
<p>  (好好体会一下。设置无序边界 和 设置有序标记的区别)</p>
<p>  优化代码如下：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span> arrary[])</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;arrary.length - <span class="number">1</span>;i++)&#123;</span><br><span class="line">            <span class="comment">//有序标记，每一轮初始值为true ,默认有序</span></span><br><span class="line">            <span class="keyword">boolean</span> isSorted = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//无序数列的边界，每次比较到这就结束</span></span><br><span class="line">            <span class="keyword">int</span> sortBorder = arrary.length - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j&lt;sortBorder; j++)&#123;</span><br><span class="line">                <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (arrary[j] &gt; arrary[j+<span class="number">1</span>])&#123;</span><br><span class="line">                    tmp = arrary[j];</span><br><span class="line">                    arrary[j] = arrary[j+<span class="number">1</span>];</span><br><span class="line">                    arrary[j+<span class="number">1</span>] = tmp;</span><br><span class="line">                    <span class="comment">//执行上面的逻辑代表还有元素进行交换了，所以不是有序的，有序标记设置为false</span></span><br><span class="line">                    isSorted = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="comment">//将当前无序数列的边界更新为最后一次交换元素的位置</span></span><br><span class="line">                    sortBorder = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//在外层循环内判断有序标记，有序true直接结束循环，无序false则继续下一轮</span></span><br><span class="line">            <span class="keyword">if</span> (isSorted)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;;</span><br><span class="line">        sort(array);</span><br><span class="line">        System.out.println(Arrays.toString(array));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>[ ] 鸡尾酒排序：冒泡排序升级版</p>
<p>冒泡排序可以根据自身大小一点一点向着数组的一侧移动，其每一轮都是从左到右来比较元素，即单向位置交换。</p>
<p>鸡尾酒排序之所以说事冒泡排序的升级版也可以说是另一个优化版本，是因为其元素比较和交换过程是双向的。</p>
<p>我们拿数列{2，3，4，5，6，7，8，1}举例，将这个数列从小到大排序。</p>
<p>如果按照冒泡排序会有什么问题？(不画图不描述了，自己debug一下冒泡排序就很清晰了~)</p>
<p>大家可以发现其实这个数列 前面7个元素都是有序的，只不过最后有一个1这个最小的，这样就会导致如果使用简单的冒泡排序就会进行7轮排序~~</p>
<p>上面我们也说了冒泡排序是单向的，只能从左往右。而鸡尾酒排序是双向的，怎么个双向法？</p>
<p>鸡尾酒排序的思路其实就像钟摆一样，第一轮从左往右排序，第二轮从右往左排序，第三轮又从左往右排序，第四轮又从右往左排序~</p>
<p><strong>如果使用鸡尾酒排序会是什么效果：</strong></p>
<p>第1轮：和冒泡排序一样从左往右排序，最终会使8和1交换，排序结果为：2，3，4，5，6，7，1，8。<strong>右侧有序区数列只有 ”8“</strong></p>
<p>第2轮：从右往左排序，即从倒数第二位(无序区第一位，记住！从右往左排的)，这样元素”1”就会慢慢慢慢的跑到第一位，排序结果为 1，2，3，4，5，6，7，8 。<strong>左侧有序区为元素”1“，右侧有序区为元素”8“</strong></p>
<p>第3轮：从左往右排序（虽然实际上已经有序了，但是流程没有结束，第三轮还得继续），此时就会发现1和2比较位置不变，2和3比较位置不变，3和4比较，位置不变。。。。。最后发现没有元素位置进行交换，证明已经有序，排序结束。</p>
<p>只需要三轮排序就可以结束~</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSort4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span> array[])</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;array.length/<span class="number">2</span>; i++)&#123;</span><br><span class="line">            <span class="comment">//有序标记，每一轮初始值为true ,默认有序</span></span><br><span class="line">            <span class="keyword">boolean</span> isSorted = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//奇数轮排序，从左往右比较和交换</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j=i; j&lt;array.length-i-<span class="number">1</span>; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (array[j] &gt; array[j+<span class="number">1</span>])&#123;</span><br><span class="line">                    tmp = array[j];</span><br><span class="line">                    array[j] = array[j+<span class="number">1</span>];</span><br><span class="line">                    array[j+<span class="number">1</span>] = tmp;</span><br><span class="line">                    <span class="comment">//执行上面的逻辑代表还有元素进行交换了，所以不是有序的，有序标记设置为false</span></span><br><span class="line">                    isSorted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//在外层循环内判断有序标记，有序true直接结束循环，无序false则继续下一轮</span></span><br><span class="line">            <span class="keyword">if</span> (isSorted)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//在偶数轮排序前，先将isSorted重新标记为true</span></span><br><span class="line">            isSorted = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//偶数轮排序，从右往左比较和交换</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=array.length-i-<span class="number">1</span>; j&gt;i; j--)&#123;</span><br><span class="line">                <span class="keyword">if</span> (array[j] &lt; array[j-<span class="number">1</span>])&#123;</span><br><span class="line">                    tmp = array[j];</span><br><span class="line">                    array[j] = array[j-<span class="number">1</span>];</span><br><span class="line">                    array[j-<span class="number">1</span>] = tmp;</span><br><span class="line">                    <span class="comment">//执行上面的逻辑代表还有元素进行交换了，所以不是有序的，有序标记设置为false</span></span><br><span class="line">                    isSorted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//在外层循环内判断有序标记，有序true直接结束循环，无序false则继续下一轮</span></span><br><span class="line">            <span class="keyword">if</span> (isSorted)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">1</span>&#125;;</span><br><span class="line">        sort(array);</span><br><span class="line">        System.out.println(Arrays.toString(array));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>鸡尾酒排序的原是实现，代码外层大循环控制排序回合，大循环内包含2个小循环，第一个小循环从左往右比较并交换元素，第二个小循环从右往左比较并交换元素。</p>
</li>
</ul>
<p>鸡尾酒排序优缺点：</p>
<p>优点：在特定条件下，减少排序的回合数。</p>
<p>缺点：代码量增加了一倍</p>
<p>使用场景：大部分元素已经有序的前提下</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kaiz.top/2019/05/30/redis实现分布式锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kaiz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kaiz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/30/redis实现分布式锁/" itemprop="url">redis实现分布式锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-30T20:42:03+08:00">
                2019-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>比较简陋，未排版，直接在代码中加的注释记录了。先上传，后面找机会排版。</p>
<h2 id="核心有两个："><a href="#核心有两个：" class="headerlink" title="核心有两个："></a>核心有两个：</h2><ol>
<li>仅使用spring-boot-starter-data-redis 实现分布式锁(代码示例1-7)</li>
<li>使用成熟框架Redisson实现分布式锁(代码示例8)</li>
</ol>
<p>引入jar包如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaiz.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Title: &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Description: &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kaiz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 19:38 2019-05-29.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Redisson redisson;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//单体架构情况下第一版</span></span><br><span class="line">        <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">        <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">            System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    goods初始数量为50</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    单体架构情况下 第一个版本代码问题：</span></span><br><span class="line"><span class="comment">    当处于高并发情况下，假设有3个线程同时请求这个接口，同时执行到第24行，那此时获取到的goods值都是50，</span></span><br><span class="line"><span class="comment">    当执行到第26行时得到的realGoods 都是49，则这3个线程都会将realGoods为49设值到key为goods的value中。</span></span><br><span class="line"><span class="comment">    然而我们实际想要的效果是当有3个用户同时秒杀购买都抢到的情况下应该库存减去3，</span></span><br><span class="line"><span class="comment">    但是现在得到的结果只是减去1，所以引起超卖的情况。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在上述单体情况下，可能首先想到的是加锁，使用jdk自带的synchronized关键字加锁，看变更后示例：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//单体架构情况下第二版</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">            <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">                System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    上述单体架构情况下第二版，这样超卖情况就解决了。</span></span><br><span class="line"><span class="comment">    但是现在单体架构的项目基本不存在了，最起码是集群 、分布式架构。</span></span><br><span class="line"><span class="comment">    而synchronized关键字只能在一个web应用实例即虚拟机上锁住。</span></span><br><span class="line"><span class="comment">    假设goods初始数量还是50，当在2个jvm实例上运行时，若不同用户同时访问上述请求并访问到第52行和54行还是会</span></span><br><span class="line"><span class="comment">    出现同时拿到goods数量为50，减一后realGoods都为49并写入redis中，出现超卖。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在上述情况下，我们可以使用redis的 SETNX命令实现分布式锁。</span></span><br><span class="line"><span class="comment">    SETNX命令只在key不存在的情况下，将建key的值设置为value。</span></span><br><span class="line"><span class="comment">    若key已经存在，则setnx命令不做任何操作，代码如下：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//非单体架构第一版</span></span><br><span class="line"></span><br><span class="line">        String lockKey = <span class="string">"lockKey"</span>;</span><br><span class="line">        <span class="comment">//是否可以拿到锁,加锁动作</span></span><br><span class="line">        Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey,<span class="string">"kaiz"</span>);<span class="comment">//jedis.setnx("lockKey","kaiz");</span></span><br><span class="line">        <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">        <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">            System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//解锁动作</span></span><br><span class="line">        stringRedisTemplate.delete(lockKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    因redis是单线程模型，即便是多个web应用实例请求且都执行83行加锁的代码，</span></span><br><span class="line"><span class="comment">    redis会按照请求到来的顺序排队一个一个执行，一定会有先后顺序。</span></span><br><span class="line"><span class="comment">    当key值存在result则会返回false,若不存在则会返回true,代表设值加锁成功，执行扣减库存操作，</span></span><br><span class="line"><span class="comment">    在业务逻辑执行完毕之后再讲lockKey锁释放。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    但是该方案也有问题：</span></span><br><span class="line"><span class="comment">    加入代码已经执行完83行即加锁操作且result返回true代表已经拿到锁，</span></span><br><span class="line"><span class="comment">    但是当执行到90行进行扣减库存设值操作时，程序抛出未知异常Exception了，</span></span><br><span class="line"><span class="comment">    那第96行释放锁的动作就永远不会执行，</span></span><br><span class="line"><span class="comment">    那么在redis中lockKey这把锁永远无法释放，其他请求过来也永远获取不到锁，永远return error。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    针对上面的情况，可能想到的方式就是使用try...finaly...，看下面代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods4"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods4</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//非单体架构第二版</span></span><br><span class="line">        String lockKey = <span class="string">"lockKey"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//是否可以拿到锁,加锁动作</span></span><br><span class="line">            Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey,<span class="string">"kaiz"</span>);<span class="comment">//jedis.setnx("lockKey","kaiz");</span></span><br><span class="line">            <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">            <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">                System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//解锁动作</span></span><br><span class="line">            stringRedisTemplate.delete(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    上面修改后，若是在设值库存值时抛出异常，我们也会在finally里进行锁的释放，不用担心锁永远获取不到了。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    但是又有新的问题：</span></span><br><span class="line"><span class="comment">    如果在执行完第121行获取锁成功后，服务器挂了，无法执行finally语句里的逻辑，</span></span><br><span class="line"><span class="comment">    此时同样无法释放锁，还是会造成上一个版本的情况。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    针对上述情况，解决思路：</span></span><br><span class="line"><span class="comment">    对设值的lockKey设置一个超时时间，</span></span><br><span class="line"><span class="comment">    当超过一定时间后，redis自动释放销毁该锁，代码如下：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods5"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods5</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//非单体架构第三版</span></span><br><span class="line">        String lockKey = <span class="string">"lockKey"</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//是否可以拿到锁,加锁动作</span></span><br><span class="line">            Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey,<span class="string">"kaiz"</span>);<span class="comment">//jedis.setnx("lockKey","kaiz");</span></span><br><span class="line">            <span class="comment">//增加超时时间</span></span><br><span class="line">            stringRedisTemplate.expire(lockKey, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">            <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">                System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//解锁动作</span></span><br><span class="line">            stringRedisTemplate.delete(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    上面修改后，针对上一个版本出现的问题即便是在未执行到finally语句里释放锁的代码逻辑之前服务器挂掉，在超过我们设置的超时时间10s后一样可以自动释放锁</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    但是又有新的问题：</span></span><br><span class="line"><span class="comment">    如果是执行完158行代码获取锁后，刚要执行160行代码设置这把锁的超时时间时 程序挂了，那么锁依旧无法释放。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    针对上述情况，解决方式：</span></span><br><span class="line"><span class="comment">    确保加锁及设置锁的过期时间必须是原子性操作，即加锁和设置锁要么都成功要么都不成功。</span></span><br><span class="line"><span class="comment">    在redis较高版本新增加的一个api，可以在setnx命令后直接增加过期时间，具体版本我没去确定。</span></span><br><span class="line"><span class="comment">    直接来看代码：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods6"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods6</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//非单体架构第四版</span></span><br><span class="line">        String lockKey = <span class="string">"lockKey"</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//            //是否可以拿到锁,加锁动作</span></span><br><span class="line"><span class="comment">//            Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey,"kaiz");//jedis.setnx("lockKey","kaiz");</span></span><br><span class="line"><span class="comment">//            //增加超时时间</span></span><br><span class="line"><span class="comment">//            stringRedisTemplate.expire(lockKey, 10, TimeUnit.SECONDS);</span></span><br><span class="line">            Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey,<span class="string">"kaiz"</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">            <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">                System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//解锁动作</span></span><br><span class="line">            stringRedisTemplate.delete(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    上面修改后，redis底层就会帮我们保证其原子性操作，上述问题也就解决了。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    上面修改后，看着没什么问题了，但是还有问题：</span></span><br><span class="line"><span class="comment">    假如A线程请求进来执行上述代码一共需要执行15s，</span></span><br><span class="line"><span class="comment">    当执行完209行代码即已经对这次购买扣减库存结束一共用了10s，此时线程还未执行完，此时锁自动失效释放了(此时lockKey不存在了)。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    假如B线程请求进来执行上述代码一共需要执行10s，</span></span><br><span class="line"><span class="comment">    执行加锁操作时可以获取锁，result为true(因为在A线程未执行完时锁已失效)，B线程执行完加锁操作后用时5s(此时lockKey又存在了)，</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    此时A线程正好执行结束（10+5），即线程A会把线程B获取的锁释放掉。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    假如C线程进来了，C线程执行上述代码一共需要执行8s，这个时候又可以获取锁了，C线程执行完加锁操作后用时5s,</span></span><br><span class="line"><span class="comment">    此时B线程又正好执行结束(5+5)，此时线程B又会把线程C获取的锁释放掉。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    最终结果就会导致：我不知道当前我这个线程到底加没加锁？在高并发情况下，这把锁很有可能就会永久失效。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      上述问题的解决思路是什么：</span></span><br><span class="line"><span class="comment">      我要确保线程A加的锁只能我线程A自己释放，</span></span><br><span class="line"><span class="comment">      所以只需要确保在释放锁的时候（执行finally代码块代码）有个标识是否是我这个线程自己加的锁，如果是我自己加的我可以释放，如果不是，我不释放。</span></span><br><span class="line"><span class="comment">      代码如下：</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods7"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods7</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//非单体架构第五版</span></span><br><span class="line">        String lockKey = <span class="string">"lockKey"</span>;</span><br><span class="line">        String clientId = UUID.randomUUID().toString();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey,clientId, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">            <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">                System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//解锁动作</span></span><br><span class="line">            <span class="keyword">if</span> (clientId.equals(stringRedisTemplate.opsForValue().get(lockKey)))&#123;</span><br><span class="line">                stringRedisTemplate.delete(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     上面修改后，通过对lockKey的value值设置为我们随机生成的clientId(原本value都是固定的kaiz),</span></span><br><span class="line"><span class="comment">     在释放锁的时候判断一把再释放就能解决上个版本的问题了。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    但是还有问题：</span></span><br><span class="line"><span class="comment">    我们上面设置的锁的超时时间不是10s吗，如果在我们实际开发过程中获取锁后执行的业务逻辑较为负责，</span></span><br><span class="line"><span class="comment">    业务逻辑执行时间超过10s了还没有执行完，这个时候redis会根据超时时间释放锁。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    不管我们把超时间时间10s更改为多少，都是根据业务逻辑拍脑袋决定的。</span></span><br><span class="line"><span class="comment">    由此引申出因锁超时导致锁失效的问题，即如何进行 锁续命。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    解决方案1：当执行完248行获取锁的操作后立马开启一个分线程，</span></span><br><span class="line"><span class="comment">    在分线程里写一个代码块，写一个timer的定时器，</span></span><br><span class="line"><span class="comment">    每隔一段时间检查当前线程是否结束，如果线程未结束则立马将这把锁的超时时间再设值一遍进行续命。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    解决方案2：redisson   请见如下：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//redisson</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/sell-goods8"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sellGoods8</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        String lockKey = <span class="string">"lockKey"</span>;</span><br><span class="line">        RLock redissonLock = redisson.getLock(lockKey);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            redissonLock.tryLock(<span class="number">30</span>,TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">int</span> goods = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">"goods"</span>)); <span class="comment">//jedis.get("goods);</span></span><br><span class="line">            <span class="keyword">if</span> (goods &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> realGoods = goods - <span class="number">1</span>;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">"goods"</span>, realGoods + <span class="string">""</span>);<span class="comment">//jendis.set("goods);</span></span><br><span class="line">                System.out.println(<span class="string">"扣减成功，剩余库存:"</span> + realGoods);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"扣减失败，库存不足"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//解锁动作</span></span><br><span class="line">            redissonLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"end"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Redisson实现分布式锁的原理：</span></span><br><span class="line"><span class="comment">      当线程A使用redisson进行加锁操作，也就是代码第318行tryLock操作后，</span></span><br><span class="line"><span class="comment">      此时线程B请求进来也要进行加锁操作时，redisson会让线程B处于while循环，一直尝试加锁也就是自旋操作。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      当线程A拿到锁了，也就是加锁成功了，redisson会在后后台开一个分线程，</span></span><br><span class="line"><span class="comment">      这个分线程所做的操作就是每隔10s检查是否还持有锁，如果持有则延长锁的时间</span></span><br><span class="line"><span class="comment">      比如我们上面代码加锁时间是30s，分线程会在10s后检查是否持有锁，若还在则继续延长30s</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      这时可能会问分线程每隔多少秒怎么设定的？ </span></span><br><span class="line"><span class="comment">      Redisson底层有默认实现根据你设置的锁的超时时间大概三分之一左右时间检查一次。</span></span><br><span class="line"><span class="comment">      比如你设置10s，可能3s多久检查一次是否需要续命。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kaiz.top/2019/05/26/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kaiz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kaiz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/26/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-26T17:03:28+08:00">
                2019-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Kaiz</p>
              <p class="site-description motion-element" itemprop="description">知其白，守其黑，为天下式。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kaiz</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
